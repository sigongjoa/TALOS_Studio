# API Specifications for MotionEq Project

This document outlines the API specifications for the core modules and functions within the MotionEq project. These specifications are intended to guide the implementation and ensure consistent interfaces between different components.

---

## 1. LLM Agent Module (`src/llm_agent/`)

### 1.1 `prompt_builder.py`

#### Function: `build_llm_prompt`

- **Purpose:** Constructs a detailed prompt string for the LLM based on user input, guiding the LLM to generate structured JSON output for OpenSim.
- **Parameters:**
    - `user_input_text` (str): The natural language description of the desired motion from the user.
- **Returns:**
    - `str`: A formatted prompt string ready to be sent to the LLM API.

### 1.2 `llm_connector.py`

#### Function: `call_llm_api`

- **Purpose:** Sends the constructed prompt to the LLM API and retrieves its JSON response. Handles API authentication and basic error checking.
- **Parameters:**
    - `prompt` (str): The detailed prompt string generated by `build_llm_prompt`.
- **Returns:**
    - `dict`: The parsed JSON response from the LLM, containing structured motion parameters.
- **Raises:**
    - `requests.exceptions.RequestException`: For network-related errors or invalid API responses.
    - `ValueError`: If the LLM response is not valid JSON or does not conform to expected structure.

### 1.3 `json_validator.py`

#### Function: `validate_opensim_json`

- **Purpose:** Validates the structure and data types of the JSON output received from the LLM to ensure it's suitable for OpenSim processing.
- **Parameters:**
    - `json_data` (dict): The JSON data received from the LLM.
- **Returns:**
    - `bool`: `True` if the JSON data is valid, `False` otherwise.

---

## 2. OpenSim Agent Module (`src/opensim_agent/`)

### 2.1 `simulate_motion.py`

#### Function: `load_opensim_model`

- **Purpose:** Loads an OpenSim musculoskeletal model from a specified `.osim` file.
- **Parameters:**
    - `model_path` (str): The absolute path to the `.osim` model file.
- **Returns:**
    - `opensim.Model`: An OpenSim Model object.
- **Raises:**
    - `FileNotFoundError`: If the `.osim` file does not exist.
    - `opensim.OpenSimException`: For errors during model loading.

#### Function: `apply_json_to_model`

- **Purpose:** Applies the motion parameters from the LLM-generated JSON data to the OpenSim model, setting target joint angles or positions.
- **Parameters:**
    - `model` (opensim.Model): The loaded OpenSim Model object.
    - `json_data` (dict): The validated JSON data containing motion parameters.
- **Returns:**
    - `opensim.Model`: The modified OpenSim Model object with applied parameters.
- **Raises:**
    - `ValueError`: If a specified joint or parameter is not found in the model.

#### Function: `run_simulation`

- **Purpose:** Executes an OpenSim simulation (e.g., Inverse Kinematics, Inverse Dynamics) based on the modified model and generates motion data files.
- **Parameters:**
    - `model` (opensim.Model): The OpenSim Model object with applied motion parameters.
    - `json_data` (dict): The validated JSON data (used for duration, specific simulation settings).
    - `output_dir` (str): The directory where the generated motion files (`.sto`, `.trc`) will be saved.
- **Returns:**
    - `str`: The path to the generated OpenSim motion file (e.g., `.sto`).
- **Raises:
    - `opensim.OpenSimException`: For errors during simulation execution.

---

## 3. Data Conversion Module (`src/data_conversion/`)

### 3.1 `convert_motion.py`

#### Function: `convert_opensim_to_bvh`

- **Purpose:** Converts an OpenSim motion file (`.sto` or `.trc`) into a Blender-compatible BVH (BioVision Hierarchy) file.
- **Parameters:**
    - `opensim_motion_file_path` (str): The path to the OpenSim motion file.
    - `output_bvh_path` (str): The desired output path for the BVH file.
    - `joint_mapping` (dict): A dictionary mapping OpenSim joint names to Blender armature bone names.
- **Returns:**
    - `str`: The path to the generated BVH file.
- **Raises:**
    - `FileNotFoundError`: If the input OpenSim motion file does not exist.
    - `ValueError`: If `joint_mapping` is incomplete or incorrect.

---

## 4. Blender Automation Module (`src/blender_automation/`)

### 4.1 `apply_motion_and_render.py`

#### Function: `automate_blender`

- **Purpose:** Loads a Blender scene, imports a BVH motion file, applies it to a character armature, and renders the animation to a video file. This function is designed to be run within Blender's Python environment.
- **Parameters:**
    - `blender_file_path` (str): The path to the base Blender scene file (`.blend`) containing the rigged character.
    - `bvh_file_path` (str): The path to the BVH motion file generated from OpenSim.
    - `output_video_path` (str): The desired output path for the rendered video file (e.g., `.mp4`).
- **Returns:**
    - `None`
- **Raises:**
    - `FileNotFoundError`: If the Blender scene or BVH file does not exist.
    - `RuntimeError`: For errors during Blender operations (e.g., import, applying motion, rendering).

---

## 5. Main Orchestration Script (`src/main.py`)

#### Function: `main`

- **Purpose:** Orchestrates the entire workflow from user input to final video rendering, calling functions from other modules.
- **Parameters:**
    - `user_input_text` (str): The natural language description of the desired motion.
- **Returns:**
    - `str`: The path to the final rendered video file.
- **Raises:**
    - Various exceptions from sub-modules, propagated up.
